#!/bin/bash
# Pre-commit hook: ×‘×“×™×§×•×ª ××•×§×“××•×ª ×œ×¤× ×™ commit
# ========================================
# 
# ×”×ª×§× ×”:
# cp scripts/pre-commit .git/hooks/pre-commit
# chmod +x .git/hooks/pre-commit
#
# ×“×™×œ×•×’ ×¢×œ ×”×‘×“×™×§×”:
# git commit --no-verify

set -e  # ×™×•×¦× ×× ×™×© ×©×’×™××”

echo "ğŸ›¡ï¸ ××¨×™×¥ ×‘×“×™×§×•×ª ××•×§×“××•×ª ×œ×¤× ×™ commit..."

# ×‘×“×™×§×” ×©×—×‘×™×œ×•×ª Python ×–××™× ×•×ª
if ! command -v python3 &> /dev/null; then
    echo "âŒ Python3 ×œ× ××•×ª×§×Ÿ!"
    exit 1
fi

# ×‘×“×™×§×” ××”×™×¨×” ×©×œ requirements.txt
echo "ğŸ“‹ ×‘×•×“×§ requirements.txt..."
if [ ! -f "requirements.txt" ]; then
    echo "âŒ requirements.txt ×œ× × ××¦×!"
    exit 1
fi

# ×‘×“×™×§×” ×©-LiteLLM × ×¢×•×œ ×œ×’×¨×¡×” ×¡×¤×¦×™×¤×™×ª
if grep -q "litellm>=" requirements.txt; then
    echo "âŒ LiteLLM ×œ× × ×¢×•×œ ×œ×’×¨×¡×” ×¡×¤×¦×™×¤×™×ª!"
    echo "   ×©× ×” litellm>= ×œ-litellm== ×‘requirements.txt"
    echo "   ×“×•×’××”: litellm==1.35.0"
    exit 1
fi

if grep -q "litellm==" requirements.txt; then
    VERSION=$(grep "litellm==" requirements.txt | cut -d'=' -f3)
    echo "âœ… LiteLLM × ×¢×•×œ ×œ×’×¨×¡×” $VERSION"
else
    echo "âš ï¸  LiteLLM ×œ× × ××¦× ×‘-requirements.txt"
fi

# ×‘×“×™×§×” ×©×§×‘×¦×™× ×§×¨×™×˜×™×™× ×§×™×™××™×
CRITICAL_FILES=("main.py" "config.py" "lazy_litellm.py")
for file in "${CRITICAL_FILES[@]}"; do
    if [ ! -f "$file" ]; then
        echo "âŒ ×§×•×‘×¥ ×§×¨×™×˜×™ ×—×¡×¨: $file"
        exit 1
    fi
done

echo "âœ… ×§×‘×¦×™× ×§×¨×™×˜×™×™× ×§×™×™××™×"

# ×‘×“×™×§×” ×©××™×Ÿ imports ×™×©×™×¨×™× ×©×œ litellm
echo "ğŸ” ×‘×•×“×§ imports ×©×œ LiteLLM..."
DIRECT_IMPORTS=$(grep -r "import litellm" --include="*.py" . | grep -v "lazy_litellm" | grep -v "pre_deploy_checks" | grep -v "__pycache__" || true)

if [ ! -z "$DIRECT_IMPORTS" ]; then
    echo "âš ï¸  × ××¦××• imports ×™×©×™×¨×™× ×©×œ LiteLLM:"
    echo "$DIRECT_IMPORTS"
    echo "   ×›×“××™ ×œ×”×©×ª××© ×‘-lazy_litellm ×‘××§×•×"
fi

# ×¨×™×¦×ª ×‘×“×™×§×ª ×ª×§×™× ×•×ª ××”×™×¨×”
echo "ğŸš€ ××¨×™×¥ ×‘×“×™×§×ª ×ª×§×™× ×•×ª ××”×™×¨×”..."
if python3 -c "
import sys
import os
sys.path.insert(0, '.')

try:
    # ×‘×“×™×§×ª syntax ×‘×¡×™×¡×™×ª
    import config
    import main
    print('âœ… Syntax check passed')
    
    # ×‘×“×™×§×” ×©×œ× ×—×¡×¨×™× ××©×ª× ×™ config ×§×¨×™×˜×™×™×
    required = ['TELEGRAM_BOT_TOKEN', 'DATA_DIR', 'PRODUCTION_PORT']
    missing = [var for var in required if not hasattr(config, var)]
    if missing:
        print(f'âŒ Missing config variables: {missing}')
        sys.exit(1)
    
    print('âœ… Config check passed')
    
except Exception as e:
    print(f'âŒ Quick health check failed: {e}')
    sys.exit(1)
"; then
    echo "âœ… ×‘×“×™×§×ª ×ª×§×™× ×•×ª ××”×™×¨×” ×¢×‘×¨×”!"
else
    echo "âŒ ×‘×“×™×§×ª ×ª×§×™× ×•×ª × ×›×©×œ×”!"
    echo "×”×¨×¥: python3 health_check.py ×œ×¤×¨×˜×™×"
    exit 1
fi

echo "ğŸ‰ ×›×œ ×”×‘×“×™×§×•×ª ×¢×‘×¨×•! commit ×××•×©×¨."