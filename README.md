# Telegram GPT Bot — Daniel

בוט טלגרם חכם מבוסס GPT-4o, עם ניהול משתמשים, לוגים, Google Sheets, דוחות אוטומטיים, והרשאות מתקדמות.

**🔄 עדכון אחרון:** ארכיטקטורה מודולרית חדשה עם handlers נפרדים וקונפיגורציה מרכזית

---

## ⚠️ הערה חשובה לפיתוח

**🚫 אסור ליצור עוד קבצי README!**

- **כל התיעוד** צריך להיות בקובץ README.md הראשי הזה בלבד
- **אין ליצור** קבצים כמו IMPLEMENTATION_SUMMARY.md, PERFORMANCE_ANALYSIS_README.md וכו'
- **כל עדכון או תוספת** צריכים להתווסף לקובץ הראשי
- **Single Source of Truth** - מקום אחד לכל המידע

הסיבה: קובץ אחד קל יותר לתחזוקה, חיפוש, ועדכון.

---

## 🎯 מטרת הבוט

בוט טלגרם חכם שמספק **תמיכה רגשית ופסיכולוגית בעברית**. הבוט מנהל שיחות אמפתיות, עוזר למשתמשים לעבד רגשות, ומספק כלים להתמודדות עם אתגרים רגשיים.

**מה הבוט עושה:**
- מנהל שיחות תרפויטיות בעברית
- עוזר למשתמשים לעבד רגשות וטראומות
- מספק תמיכה בהתמודדות עם הומופוביה פנימית וחיצונית
- בונה פרופיל רגשי מתעדכן לכל משתמש
- שומר היסטוריית שיחות לצורך המשכיות טיפולית

**קהל היעד:** אנשים המחפשים תמיכה רגשית, במיוחד מהקהילה הלהט"בית, הזקוקים למרחב בטוח לשיחה על רגשות ואתגרים.

---

## 🚨 חשוב מאוד - שתי סביבות נפרדות!

### סביבה 1 - רנדר (ייצור):
- **הפעלה:** `python main.py`
- **לא משתמש ב-ngrok**
- **לא משתמש ב-sandbox.py**
- **רץ על פורט 8000 עם HTTP server פשוט**
- **מיועד לסביבת ייצור בלבד**

### סביבה 2 - לוקאלית (פיתוח):
- **הפעלה:** `python sandbox.py` ✅
- **משתמש ב-ngrok**
- **רץ על פורט 10000 עם uvicorn**
- **מיועד לפיתוח לוקאלי בלבד**

⚠️ **אזהרה חשובה:** אל תשנה את `main.py` כדי שיתאים לסביבה לוקאלית! הסביבה ברנדר לא אמורה לדעת בכלל על `sandbox.py`!

---

## 🚀 תכונות עיקריות

- מענה חכם בעברית (GPT-4o)
- ניהול משתמשים והרשאות בגיליונות Google Sheets
- לוגים מלאים לכל הודעה, כולל usage, עלויות, שגיאות
- דוחות usage ודוחות שגיאות אוטומטיים לאדמין
- מערכת הרשאות קשיחה (אדמין בלבד לפקודות רגישות)
- קוד מסודר, הודעות מרוכזות, שדות מרוכזים, דוקומנטציה מלאה
- **🆕 LiteLLM Integration** - ניהול עלויות מתקדם ותמיכה במודלים מרובים

### 🧠 מערכת 5 מנועי GPT מודולרית:
- **gpt_a** - תשובה ראשית למשתמש (Gemini 2.5 Pro + fallback ל-Flash)
- **gpt_b** - תמצות תשובות להיסטוריה (Gemini 1.5 Pro - חינמי)
- **gpt_c** - חילוץ פרופיל ראשוני (Gemini 1.5 Pro - חינמי)
- **gpt_d** - מיזוג ואיכות פרופיל (Gemini 1.5 Pro - חינמי)
- **gpt_e** - עדכון פרופיל מתקדם (Gemini 1.5 Pro - חינמי)

### ⚡ מערכת Concurrent Handling מתקדמת:
- **עד 10 משתמשים במקביל** עם זמני תגובה של 2-4 שניות
- **FIFO Ordering** - כל משתמש מקבל שירות לפי סדר הגעה
- **מנגנוני בטיחות** - Circuit Breaker, Timeout Protection, Auto Recovery
- **Google Sheets Queue** - תור אסינכרוני עם Rate Limiting (60 ops/min)
- **ניטור בזמן אמת** - מטריקות ביצועים והתראות אוטומטיות לאדמין
- **Graceful Degradation** - התנהגות יציבה בעומסים גבוהים
- **🚨 הגנה מפני קריסות** - מונע קריסת Google Sheets API ומערכת הבוט בעומסים גבוהים

### 🎤 תמיכה בהודעות קוליות:
- **תמלול אוטומטי לעברית** באמצעות Whisper-Ivrit
- **הרצה מקומית חינמית** - אין עלויות API נוספות
- **ביצועים מהירים** עם faster-whisper
- **טיפול בשגיאות** וניקוי קבצים זמניים
- **הודעות מותאמות** לכל סוגי ההודעות הלא-טקסטואליות

### 🚀 שיפורים חכמים לבוט:

#### 1. ⏳ מנגנון הודעות זמניות
- אם GPT לוקח יותר מ-5 שניות להגיב, הבוט שולח הודעה זמנית: "⏳ אני עובד על תשובה בשבילך... זה מיד אצלך..."
- כשהתשובה מגיעה, ההודעה הזמנית מוחלפת בתשובה האמיתית
- אם GPT מהיר מ-5 שניות, ההודעה הזמנית מבוטלת לפני שנשלחת

#### 2. 🎯 פילטר חכם לבחירת מודל (מוטמע ב-gpt_a_handler.py)
**קריטריונים למודל מתקדם (Gemini 2.5 Pro):**
- הודעות ארוכות: מעל 50 מילים
- מילות מפתח מורכבות: 115 מילות מפתח כמו "זוגיות", "דתיות", "פסיכולוגיה", "קריירה" וכו'
- דפוסי ביטויים: "מה עושים כש...", "איך להתמודד עם...", "לא יודע איך..."
- היסטוריה מורכבת: מעל 10 הודעות בשיחה

**במקרים אחרים:** Gemini Flash - מהיר, איכותי, וחינמי

#### 3. 📄 מודול gpt_e - חידוד ותיקון פרופיל רגשי
`gpt_e` הוא מנגנון חכם שמשלים ומתקן את הפרופיל הרגשי של כל משתמש על בסיס השיחה האחרונה + הפרופיל הקיים.

**מתי המודול מופעל:**
- אם gpt_c_run_count >= 50
- או אם gpt_c_run_count >= 21 וחלפו 24 שעות מאז הפעלה אחרונה

**פונקציות עיקריות:**
- גילוי מידע רגשי שנאמר במרומז או לאורך זמן
- תיקון טעויות או שיבושים שהוזנו בעבר
- חידוד והתפתחויות בזהות הרגשית של המשתמש

---

## 📦 התקנה והפעלה

### ⚠️ חשוב: הפעל את הבוט רק דרך sandbox.py!

📝 **הערה: מדריך זה מיועד לסביבת פיתוח לוקאלית (Cursor IDE) בלבד!**
בסביבת ייצור (production) יש להשתמש בהגדרות שרת מתאימות.

🚨 **הפעלה בסביבה לוקאלית:**
   ```bash
   python sandbox.py  ✅
   ```
   
   ❌ **אל תפעיל ישירות:**
   ```bash
   python main.py  ❌
   ```

1. **שכפול הריפו**
2. **הפעלת הבוט (הדרך הנכונה)**
   ```bash
   python sandbox.py
   ```
   
   הקובץ `sandbox.py`:
   - יוצר ומגדיר את סביבת הפיתוח (venv) אוטומטית
   - מתקין את כל התלויות הנדרשות
   - מפעיל את ngrok אוטומטית
   - מגדיר את webhook בטלגרם
   - מפעיל את הבוט עם uvicorn

3. **הגדרת קובץ קונפיגורציה**
   - ערוך את `etc/secrets/config.json` לפי הדוגמה למטה.

### ❌ אל תפעיל ישירות:
- `python main.py` - לא יעבוד כראוי
- `uvicorn main:app_fastapi` - חסר הגדרות סביבה

---

## ⚙️ דוגמת קובץ config.json
```json
{
  "TELEGRAM_BOT_TOKEN": "<הכנס כאן את הטוקן שלך>",
  "OPENAI_API_KEY": "<הכנס כאן את ה-API KEY שלך>",
  "GEMINI_API_KEY": "<הכנס כאן את ה-Gemini API KEY שלך>",
  "GOOGLE_SHEET_ID": "<מזהה הגיליון שלך>",
  "SERVICE_ACCOUNT_DICT": { ... },
  "ADMIN_BOT_TELEGRAM_TOKEN": "<טוקן בוט אדמין (רשות)>",
  "SHEET_USER_TAB": "user_profiles",
  "SHEET_LOG_TAB": "log",
  "SHEET_STATES_TAB": "user_states"
}
```

**🆕 קונפיגורציה מרכזית:**
- **שמות גיליונות:** רק ב-`config.json` - שינוי אחד משפיע על הכל
- **מודלים ופרמטרים:** רק ב-`config.py` - Single Source of Truth
- **שער דולר:** רק ב-`gpt_utils.py` - עדכון אוטומטי בכל מקום

---

## 🗂️ מבנה הקוד

### 📁 **קבצים עיקריים:**
- `main.py` — נקודת כניסה, FastAPI webhook
- `bot_setup.py` — אתחול הבוט, תזמון דוחות
- `message_handler.py` — טיפול בכל הודעה
- `sheets_handler.py` — עבודה מול Google Sheets
- `config.py` — הגדרות מרכזיות, מודלים ופרמטרים
- `utils.py` — לוגים, דוחות, בדיקות תקינות
- `messages.py` — כל ההודעות הקבועות
- `fields_dict.py` — כל שמות השדות במקום אחד
- `notifications.py` — התראות לאדמין, טיפול בשגיאות
- `secret_commands.py` — פקודות סודיות לאדמין
- `daily_summary.py` — דוחות יומיים
- `voice_handler.py` — תמלול הודעות קוליות לעברית

### 🧠 **מנועי GPT (Handlers):**
- `gpt_a_handler.py` — מנוע ראשי לתשובות איכותיות (עם פילטר חכם)
- `gpt_b_handler.py` — מנוע תמצות להיסטוריה
- `gpt_c_handler.py` — מנוע חילוץ פרופיל ראשוני
- `gpt_d_handler.py` — מנוע מיזוג ואיכות פרופיל
- `gpt_e_handler.py` — מנוע עדכון פרופיל מתקדם
- `gpt_utils.py` — כלים משותפים (עלויות, נורמליזציה)

### 🛡️ **מערכת הגנה והפקוד:**
- `concurrent_monitor.py` — **🚨 קובץ קריטי!** מערכת הגנה מפני עומסים וקריסות
  - **למה קריטי:** מגביל ל-10 משתמשים במקביל, מגן על Google Sheets API מקריסה
  - **אל תמחק!** בלעדיו הבוט יקרוס בעומסים של 20+ משתמשים בו-זמנית
  - **משמש ב:** message_handler.py (15+ מקומות), secret_commands.py

### 📊 **מערכת אבחון ביצועים:**
- `performance_monitor_advanced.py` — **🚫 מבוטל זמנית** (לא פעיל כרגע)
- ~~`test_performance_system.py`~~ — לא בשימוש

### 📁 **תיקיות נוספות:**
- `recycle_bin/` — קבצים זמניים מהמיגרציה (לא עולה ל-GitHub)
- `tests/` — בדיקות אוטומטיות
- `data/` — נתונים ולוגים

---

## 📊 ~~מערכת אבחון צוואר בקבוק~~ (מבוטל זמנית)

### 🚫 המערכת לא פעילה כרגע

מערכת הביצועים הסרה זמנית לפשטות הקוד:

- ~~**TTFT (Time To First Token)**~~ - לא נמדד כרגע
- ~~**TPS (Tokens Per Second)**~~ - לא נמדד כרגע  
- **הבוט עובד תקין** בלי מערכת הביצועים

**למפתחים:** ניתן להחזיר את המערכת בעתיד אם נדרש.

### 📝 הערה למפתחים

המערכת הוסרה כדי לשמור על פשטות הקוד. אם תרצה להחזיר אותה בעתיד:
1. השב את הקובץ `performance_monitor.py` 
2. החזר את הקוד בgpt_a_handler.py
3. הוסף את פקודות האדמין הרלוונטיות

---

## 🚀 מבני נתונים והקבצים

הבוט שומר נתונים בקבצים מקומיים וב-Google Sheets:

### Google Sheets:
- **user_profiles** - פרופילי משתמשים, היסטוריה קצרה
- **log** - לוגים מלאים של כל הודעה
- **user_states** - מצבי משתמשים ומשתנים זמניים

### קבצים מקומיים:
- `data/conversations/` - היסטורית שיחות מלאה
- לוגי שגיאות ודוחות מגוונים

---

## 🔧 פקודות אדמין

הבוט כולל מערכת פקודות סודיות לאדמין:

- `#status` - מצב המערכת והסטטיסטיקות
- `#users` - רשימת משתמשים פעילים
- `#errors` - דוח שגיאות אחרונות
- `#broadcast` - שליחת הודעה לכל המשתמשים
- ~~`#perf_status`~~ - מערכת ביצועים מבוטלת
- ~~`#perf_analyze`~~ - מערכת ביצועים מבוטלת
- ~~`#perf_clear`~~ - מערכת ביצועים מבוטלת

---

## 🛠️ פיתוח ותחזוקה

### הרצת בדיקות:
```bash
# אין כרגע בדיקות אוטומטיות פעילות
```

### עדכון התלויות:
```bash
uv sync
```

### ניטור לוגים:
הבוט יוצר לוגים מפורטים בתיקיית `data/` ושולח דוחות אוטומטיים לאדמין.

### גיבוי נתונים:
רשומות שמורות בגיליונות Google ובקבצים מקומיים לאבטחה מרבית.

---

## 📞 תמיכה ופתרון בעיות

### בעיות נפוצות:
1. **"הבוט לא עונה"** → בדוק טוקן טלגרם וחיבור לאינטרנט
2. **"שגיאות Google Sheets"** → בדוק הרשאות Service Account
3. **"תגובות איטיות"** → בדוק חיבור לאינטרנט ועומס השרת
4. **"שגיאות מערכת"** → בדוק שגיאות בלוגים

### מידע נוסף:
- הרץ בדיקות אוטומטיות לוודא תקינות המערכת
- שימוש בפקודות אדמין לניטור שוטף
- עדכונים שוטפים לפי התקדמות הפרויקט

---

## 📋 מצבי המערכת

המערכת בנויה להיות עמידה ויציבה:

- **Circuit Breaker** - הגנה מפני כישלונות
- **Rate Limiting** - מניעת עומס יתר על ה-APIs
- **Error Recovery** - התאוששות אוטומטית מבעיות
- **Monitoring** - ניטור בזמן אמת של הביצועים

המערכת מוכנה לטיפול ב-10+ משתמשים במקביל בביצועים אופטימליים.

**פותח על ידי:** AI Assistant  
**תאריך:** 2025  
**גרסה:** 2.0 - מאוחדת ומחודשת 