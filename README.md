# Telegram GPT Bot — Daniel

בוט טלגרם חכם מבוסס GPT-4o, עם ניהול משתמשים, לוגים, Google Sheets, דוחות אוטומטיים, והרשאות מתקדמות.

**🔄 עדכון אחרון:** ארכיטקטורה מודולרית חדשה עם handlers נפרדים וקונפיגורציה מרכזית

**🚨 תיקון קריטי אבטחה (29/12/2024):** 
- ✅ **תוקנה חשיפת מידע פרטי למשתמש** - הסרת הודעות "[עדכון פרופיל]" מההיסטוריה שנשלחת ל-GPT
- ✅ **תוקנה כפילות הודעות** - הסרת race condition ב-update_chat_history 
- ✅ **הוספת 3 שכבות אבטחה** - בדיקות CRITICAL SECURITY ב-format_text_for_telegram, send_message, ו-send_message_with_retry
- ✅ **פילטר אבטחה ב-get_chat_history_messages** - מונע הודעות פנימיות מלהגיע ל-GPT
- ✅ **הגנה מרובדת** - כל הודעה שמתחילה ב-"[" ומכילה מילים כמו "עדכון", "debug", "admin" חסומה

**🔧 תיקון אחרון:** הוספה החרגה לברכות זמן - אם המשתמש כותב "היי", "שלום", "אהלן" או ברכות דומות, הבוט ישלח ברכת זמן מתאימה (בוקר טוב/צהריים טובים וכו') גם אם עברו פחות מ-2 שעות מהשיחה האחרונה. זה מזהה תחילת שיחה חדשה. נוסף דיבאג מפורט שמראה איזה summary נשלח ומאיפה הוא מגיע (בשורה אחת לטרמינל מסודר).

**🚀 שיפור נוסף:** שימוש בביטוי רגולרי חכם לזיהוי ברכות בסיסיות - במקום רשימה ארוכה של גרסאות, הבוט מזהה את המילים הבסיסיות + עד 2 תווים נוספים (אימוג'י, סימן קריאה וכו'). זה מכסה כל גרסה אפשרית של "היי", "שלום", "אהלן" וכו'.

---

## ⚠️ הערה חשובה לפיתוח

**🚫 אסור ליצור עוד קבצי README!**

- **כל התיעוד** צריך להיות בקובץ README.md הראשי הזה בלבד
- **אין ליצור** קבצים כמו IMPLEMENTATION_SUMMARY.md, PERFORMANCE_ANALYSIS_README.md וכו'
- **כל עדכון או תוספת** צריכים להתווסף לקובץ הראשי
- **Single Source of Truth** - מקום אחד לכל המידע

הסיבה: קובץ אחד קל יותר לתחזוקה, חיפוש, ועדכון.

---

## 🕐 לוגיקת זמן חשובה - יום מתחיל ב-5 בבוקר

**העיקרון:** יום מתחיל ב-5 בבוקר, לא בחצות. כל מה שקורה לפני 5 בבוקר שייך ללילה הקודם.

**דוגמאות:**
- 3:00 בלילה = עדיין הלילה של אתמול
- 5:00 בבוקר = תחילת יום חדש
- 23:00 בערב = עדיין היום הנוכחי

**איך זה מיושם בקוד:**
- `get_effective_time("datetime")` - מחזיר זמן מלא לפי לוגיקה זו
- `get_effective_time("date")` - מחזיר תאריך לפי לוגיקה זו
- `get_effective_time("night_check")` - בודק אם זה שעת לילה (23:00-05:00)

**למה זה חשוב:**
- ברכות יום נשלחות רק ביום החדש (אחרי 5:00)
- חגים נבדקים לפי היום האמיתי (לא לפי חצות)
- היסטוריית שיחות מתארגנת לפי ימים אמיתיים

**⚠️ חשוב:** כל הפונקציות שמטפלות בזמן צריכות להשתמש בפונקציות המרכזיות האלה!

---

## 🎯 מטרת הבוט

בוט טלגרם חכם שמספק **תמיכה רגשית ופסיכולוגית בעברית**. הבוט מנהל שיחות אמפתיות, עוזר למשתמשים לעבד רגשות, ומספק כלים להתמודדות עם אתגרים רגשיים.

**מה הבוט עושה:**
- מנהל שיחות תרפויטיות בעברית
- עוזר למשתמשים לעבד רגשות וטראומות
- מספק תמיכה בהתמודדות עם הומופוביה פנימית וחיצונית
- בונה פרופיל רגשי מתעדכן לכל משתמש
- שומר היסטוריית שיחות לצורך המשכיות טיפולית

**קהל היעד:** אנשים המחפשים תמיכה רגשית, במיוחד מהקהילה הלהט"בית, הזקוקים למרחב בטוח לשיחה על רגשות ואתגרים.

---

## 🚨 חשוב מאוד - שתי סביבות נפרדות!

### סביבה 1 - רנדר (ייצור):
- **הפעלה:** `python main.py`
- **לא משתמש ב-ngrok**
- **לא משתמש ב-sandbox.py**
- **רץ על פורט 8000 עם HTTP server פשוט**
- **מיועד לסביבת ייצור בלבד**

### סביבה 2 - לוקאלית (פיתוח):
- **הפעלה:** `python sandbox.py` ✅
- **משתמש ב-ngrok**
- **רץ על פורט 10000 עם uvicorn**
- **מיועד לפיתוח לוקאלי בלבד**

⚠️ **אזהרה חשובה:** אל תשנה את `main.py` כדי שיתאים לסביבה לוקאלית! הסביבה ברנדר לא אמורה לדעת בכלל על `sandbox.py`!

---

## 🚀 תכונות עיקריות

- מענה חכם בעברית (GPT-4o + Gemini)
- ניהול משתמשים והרשאות בגיליונות Google Sheets
- לוגים מלאים לכל הודעה, כולל usage, עלויות, שגיאות
- דוחות usage ודוחות שגיאות אוטומטיים לאדמין
- מערכת הרשאות קשיחה (אדמין בלבד לפקודות רגישות)
- קוד מסודר, הודעות מרוכזות, שדות מרוכזים, דוקומנטציה מלאה
- **🆕 LiteLLM Integration** - ניהול עלויות מתקדם ותמיכה במודלים מרובים

### 🧠 מערכת 5 מנועי GPT מודולרית:
- **gpt_a** - תשובה ראשית למשתמש (Gemini 2.5 Pro + fallback ל-Flash)
- **gpt_b** - תמצות תשובות להיסטוריה (Gemini 1.5 Pro - חינמי)
- **gpt_c** - חילוץ פרופיל ראשוני (Gemini 1.5 Pro - חינמי)
- **gpt_d** - מיזוג ואיכות פרופיל (Gemini 1.5 Pro - חינמי)
- **gpt_e** - עדכון פרופיל מתקדם (Gemini 1.5 Pro - חינמי)

### 🤖 מערכת הקשר אנושי חכמה (Human Context System):
- **טטאמפ מינימלי** בהיסטוריה: `[27/12 14:01] הודעת המשתמש`
- **ברכות זמן חכמות** (רק אחרי פער 3+ שעות): "בוקר טוב!" / "צהריים טובים!" / "ערב טוב!" / "לילה טוב!"
- **ברכות יום מותאמות** (רק פעם ביום, אחרי פער 6+ שעות):
  - ראשון: "איך מתחיל השבוע?"
  - שני: "איך עובר עליך השבוע?"
  - רביעי: "אמצע השבוע, איך זה עובר עליך?"
  - חמישי: "איך עבר עליך השבוע? יש תוכניות לסופש?"
  - שישי: "איך אתה מסכם את השבוע? איפה אתה עושה ארוחת ערב הערב?"
  - שבת: "איך עובר עליך הסופש?"
- **לוגיקה חכמה**: לא מציג מידע מיותר בשיחות רצופות, רק כשמשמעותי
- **עברית טבעית**: כל ההקשר בעברית למטבעיות המקסימלית

### ⚡ מערכת Concurrent Handling מתקדמת:
- **עד 50 משתמשים במקביל** עם זמני תגובה של 2-4 שניות
- **FIFO Ordering** - כל משתמש מקבל שירות לפי סדר הגעה
- **מנגנוני בטיחות** - Circuit Breaker, Timeout Protection, Auto Recovery
- **Google Sheets Queue** - תור אסינכרוני עם Rate Limiting (60 ops/min)
- **ניטור בזמן אמת** - מטריקות ביצועים והתראות אוטומטיות לאדמין
- **Graceful Degradation** - התנהגות יציבה בעומסים גבוהים
- **🚨 הגנה מפני קריסות** - מונע קריסת Google Sheets API ומערכת הבוט בעומסים גבוהים

### 🎤 תמיכה בהודעות קוליות:
- **תמלול אוטומטי לעברית** באמצעות Whisper-Ivrit
- **הרצה מקומית חינמית** - אין עלויות API נוספות
- **ביצועים מהירים** עם faster-whisper
- **טיפול בשגיאות** וניקוי קבצים זמניים
- **הודעות מותאמות** לכל סוגי ההודעות הלא-טקסטואליות

### 🚀 שיפורים חכמים לבוט:

#### 1. ⏳ מנגנון הודעות זמניות
- אם GPT לוקח יותר מ-6 שניות להגיב, הבוט שולח הודעה זמנית: "⏳ אני עובד על תשובה בשבילך... זה מיד אצלך..."
- כשהתשובה מגיעה, ההודעה הזמנית מוחלפת בתשובה האמיתית
- אם GPT מהיר מ-6 שניות, ההודעה הזמנית מבוטלת לפני שנשלחת

#### 2. 🎯 פילטר חכם לבחירת מודל (מוטמע ב-gpt_a_handler.py)
**קריטריונים למודל מתקדם (Gemini 2.5 Pro):**
- 🆕 **20 ההודעות הראשונות**: רושם ראשוני חשוב - מודל מתקדם אוטומטי
- הודעות ארוכות: מעל 50 מילים
- מילות מפתח מורכבות: 115 מילות מפתח כמו "זוגיות", "דתיות", "פסיכולוגיה", "קריירה" וכו'
- דפוסי ביטויים: "מה עושים כש...", "איך להתמודד עם...", "לא יודע איך..."
- היסטוריה מורכבת: מעל 10 הודעות בשיחה

**במקרים אחרים:** Gemini Flash - מהיר, איכותי, וחינמי

**דוגמה מעשית:**
```
משתמש חדש (הודעה 1-20): "שלום, אני מרגיש קצת אבוד"
→ מודל מתקדם (Gemini 2.5 Pro) - רושם ראשוני חשוב

משתמש ותיק (הודעה 21+): "מה שלומך?"
→ מודל מהיר (Gemini Flash) - שיחה רגילה
```

**📊 ניתוח סטטיסטי:**
המערכת מתעדת את כל החלטות הפילטר ומספקת ניתוח:
- אחוז שימוש במודל מתקדם
- פילוח לפי סוגי החלטות (הודעות ראשונות, מילות מפתח, אורך וכו')
- מעקב אחר ביצועים ועלויות

#### 3. 📄 מודול gpt_e - חידוד ותיקון פרופיל רגשי
`gpt_e` הוא מנגנון חכם שמשלים ומתקן את הפרופיל הרגשי של כל משתמש על בסיס השיחה האחרונה + הפרופיל הקיים.

**מתי המודול מופעל:**
- אם gpt_c_run_count >= 50
- או אם gpt_c_run_count >= 21 וחלפו 24 שעות מאז הפעלה אחרונה

**פונקציות עיקריות:**
- גילוי מידע רגשי שנאמר במרומז או לאורך זמן
- תיקון טעויות או שיבושים שהוזנו בעבר
- חידוד והתפתחויות בזהות הרגשית של המשתמש

---

## 📦 התקנה והפעלה

### ⚠️ חשוב: הפעל את הבוט רק דרך sandbox.py!

📝 **הערה: מדריך זה מיועד לסביבת פיתוח לוקאלית (Cursor IDE) בלבד!**
בסביבת ייצור (production) יש להשתמש בהגדרות שרת מתאימות.

🚨 **הפעלה בסביבה לוקאלית:**
   ```bash
   python sandbox.py  ✅
   ```
   
   ❌ **אל תפעיל ישירות:**
   ```bash
   python main.py  ❌
   ```

1. **שכפול הריפו**
2. **הפעלת הבוט (הדרך הנכונה)**
   ```bash
   python sandbox.py
   ```
   
   הקובץ `sandbox.py`:
   - יוצר ומגדיר את סביבת הפיתוח (venv) אוטומטית
   - מתקין את כל התלויות הנדרשות
   - מפעיל את ngrok אוטומטית
   - מגדיר את webhook בטלגרם
   - מפעיל את הבוט עם uvicorn

3. **הגדרת קובץ קונפיגורציה**
   - ערוך את `etc/secrets/config.json` לפי הדוגמה למטה.

### ❌ אל תפעיל ישירות:
- `python main.py` - לא יעבוד כראוי
- `uvicorn main:app_fastapi` - חסר הגדרות סביבה

---

## ⚙️ דוגמת קובץ config.json
```json
{
  "TELEGRAM_BOT_TOKEN": "<הכנס כאן את הטוקן שלך>",
  "OPENAI_API_KEY": "<הכנס כאן את ה-API KEY שלך>",
  "GEMINI_API_KEY": "<הכנס כאן את ה-Gemini API KEY שלך>",
  "GOOGLE_SHEET_ID": "<מזהה הגיליון שלך>",
  "SERVICE_ACCOUNT_DICT": { ... },
  "ADMIN_BOT_TELEGRAM_TOKEN": "<טוקן בוט אדמין (רשות)>",
  "SHEET_USER_TAB": "user_profiles",
  "SHEET_LOG_TAB": "log",
  "SHEET_STATES_TAB": "user_states"
}
```

**🆕 קונפיגורציה מרכזית:**
- **שמות גיליונות:** רק ב-`config.json` - שינוי אחד משפיע על הכל
- **מודלים ופרמטרים:** רק ב-`config.py` - Single Source of Truth
- **שער דולר:** רק ב-`gpt_utils.py` - עדכון אוטומטי בכל מקום

---

## 🎭 דוגמאות פעולה - מערכת הקשר אנושי

### **מצב 1: משתמש חדש (אין הקשר)**
```
משתמש: "שלום, איך אתה?"
GPT מקבל רק: הפרומט הראשי + הודעת המשתמש
→ תשובה רגילה ללא הקשר זמן
```

### **מצב 2: שיחה רצופה (אין פער זמן)**
```
משתמש: "ואיך זה עם העבודה?"
GPT מקבל: היסטוריה + הודעה חדשה (ללא הקשר זמן)
→ המשך טבעי של השיחה
```

### **מצב 3: משתמש חוזר אחרי 4 שעות בבוקר**
```
משתמש: "שלום שוב"
GPT מקבל:
[SYSTEM] "בוקר טוב!"
[USER] "שלום שוב"
→ "בוקר טוב! איך השינה? איך מתחיל היום?"
```

### **מצב 4: משתמש כותב ביום שישי אחרי פער של 8 שעות**
```
משתמש: "מה המצב?"
GPT מקבל:
[SYSTEM] "ערב טוב! אגב היום יום שישי, השעה 19:30 - איך אתה מסכם את השבוע? איפה אתה עושה ארוחת ערב הערב?"
[USER] "מה המצב?"
→ "ערב טוב! איך הסוף שבוע? איך היה השבוע בסך הכל?"
```

### **מצב 5: הודעה עם טטאמפ בהיסטוריה**
```
GPT רואה בהיסטוריה:
[USER] "[27/12 09:15] בוקר טוב, איך אתה?"
[ASSISTANT] "בוקר טוב! אני מצוין, איך אתה מרגיש היום?"
[USER] "[27/12 14:30] אני עכשיו במשרד..."
→ GPT מבין את הרצף הזמני ויכול להתייחס אליו
```

---

## 🗂️ מבנה הקוד

### 📁 **קבצים עיקריים:**
- `main.py` — נקודת כניסה, FastAPI webhook
- `bot_setup.py` — אתחול הבוט, תזמון דוחות
- `message_handler.py` — טיפול בכל הודעה
- `sheets_handler.py` — עבודה מול Google Sheets
- `config.py` — הגדרות מרכזיות, מודלים ופרמטרים
- `utils.py` — לוגים, דוחות, בדיקות תקינות
- `messages.py` — כל ההודעות הקבועות
- `fields_dict.py` — כל שמות השדות במקום אחד
- `notifications.py` — התראות לאדמין, טיפול בשגיאות
- `secret_commands.py` — פקודות סודיות לאדמין
- `daily_summary.py` — דוחות יומיים
- `voice_handler.py` — תמלול הודעות קוליות לעברית

### 🧠 **מנועי GPT (Handlers):**
- `gpt_a_handler.py` — מנוע ראשי לתשובות איכותיות (עם פילטר חכם)
- `gpt_b_handler.py` — מנוע תמצות להיסטוריה
- `gpt_c_handler.py` — מנוע חילוץ פרופיל ראשוני
- `gpt_d_handler.py` — מנוע מיזוג ואיכות פרופיל
- `gpt_e_handler.py` — מנוע עדכון פרופיל מתקדם

### 🔧 **מערכת הקשר אנושי (טכני):**
- `utils.py::get_user_stats()` — איסוף נתוני המשתמש (זמנים, הודעות, מילות מפתח)
- `utils.py::create_human_context_for_gpt()` — יצירת הודעת הקשר חכמה ל-GPT
- `utils.py::update_chat_history()` — שמירת הודעות עם טטאמפ מינימלי
- `utils.py::get_chat_history_messages()` — טעינת היסטוריה עם זמנים
- `gpt_a_handler.py` — הזרקת הקשר כ-system message לפני התשובה
- `gpt_utils.py` — כלים משותפים (עלויות, נורמליזציה)

### 🛡️ **מערכת הגנה והפקוד:**
- `concurrent_monitor.py` — **🚨 קובץ קריטי!** מערכת הגנה מפני עומסים וקריסות
  - **למה קריטי:** מגביל ל-50 משתמשים במקביל, מגן על Google Sheets API מקריסה
  - **אל תמחק!** בלעדיו הבוט יקרוס בעומסים של 20+ משתמשים בו-זמנית
  - **משמש ב:** message_handler.py (15+ מקומות), secret_commands.py

### 📁 **תיקיות נוספות:**
- `recycle_bin/` — קבצים זמניים מהמיגרציה (לא עולה ל-GitHub)
- `tests/` — בדיקות אוטומטיות
- `data/` — נתונים ולוגים

---

## 📊 מערכת בקרת לוגים

הבוט כולל מערכת מתקדמת לבקרת רמת הלוגים המאפשרת לך לשלוט בדיוק איזה מידע מוצג.

### 🎛️ הגדרות זמינות ב-`config.py`

```python
# ⚙️ הגדרות ברירת מחדל - מותאמות לפרודקשן!
DEFAULT_LOG_LEVEL = "INFO"
ENABLE_DEBUG_PRINTS = False           # דיבאג כללי (False = רזה יותר)
ENABLE_GPT_COST_DEBUG = True          # עלויות GPT (מומלץ TRUE!)
ENABLE_SHEETS_DEBUG = False           # דיבאג גיליונות Google
ENABLE_PERFORMANCE_DEBUG = True       # זמני תגובה (מומלץ TRUE!)
ENABLE_MESSAGE_DEBUG = True           # הודעות בסיסיות
ENABLE_DATA_EXTRACTION_DEBUG = True   # חילוץ נתונים מ-GPT C,D,E (מומלץ TRUE!)
```

### 🔍 מה מוצג תמיד (ללא תלות בהגדרות):

**מידע חיוני לתפעול הבוט:**
- `🔍 [GPT-C] חולצו 3 שדות: ['age', 'occupation', 'goal']` - מה נחלץ מהודעות המשתמש
- `🔄 [GPT-D] מוזגו 5 שדות` - איך מתבצע מיזוג נתונים
- `💾 [SAVE] שדה 'age' ← 'בן 25' (עמודה 4)` - איך נתונים נשמרים בגיליון
- `✅ [SAVED] נשמרו 3 שדות: age, occupation, goal` - סיכום השמירה
- `⏱️ [GPT_TIMING] GPT הסתיים תוך 2.34 שניות` - זמני תגובה

### 💰 מידע עלויות (כאשר `ENABLE_GPT_COST_DEBUG = True`):
- `💰 [GPT-C] עלות: 0.001200$ | טוקנים: 1250`
- `💰 [GPT-A] עלות: 0.003400$ | טוקנים: 2100`

### 📋 פירוט נתונים (כאשר `ENABLE_DATA_EXTRACTION_DEBUG = True`):
```json
📋 [GPT-C] נתונים שחולצו: {
  "age": "בן 25",
  "occupation": "מהנדס תוכנה",
  "goal": "לשפר ביטחון עצמי"
}
```

### 🚀 תרחישי שימוש מומלצים

**🎯 פרודקשן (רזה אבל עם מידע חיוני):**
```python
ENABLE_DEBUG_PRINTS = False
ENABLE_GPT_COST_DEBUG = True          # חשוב לראות עלויות!
ENABLE_PERFORMANCE_DEBUG = True       # חשוב לראות זמנים!
ENABLE_DATA_EXTRACTION_DEBUG = True   # חשוב לראות מה נשמר!
ENABLE_SHEETS_DEBUG = False
ENABLE_MESSAGE_DEBUG = True
```

**🔬 פיתוח מלא:**
```python
ENABLE_DEBUG_PRINTS = True
ENABLE_GPT_COST_DEBUG = True
ENABLE_PERFORMANCE_DEBUG = True
ENABLE_DATA_EXTRACTION_DEBUG = True
ENABLE_SHEETS_DEBUG = True
ENABLE_MESSAGE_DEBUG = True
```

**⚠️ דיבאג ממוקד (רק GPT):**
```python
ENABLE_DEBUG_PRINTS = False
ENABLE_GPT_COST_DEBUG = True
ENABLE_PERFORMANCE_DEBUG = False
ENABLE_DATA_EXTRACTION_DEBUG = True
ENABLE_SHEETS_DEBUG = False
ENABLE_MESSAGE_DEBUG = False
```

### 🎛️ בדיקת מצב הלוגים

**פקודה פשוטה:**

```bash
# הצגת מצב נוכחי
python utils.py log-status
```

**דוגמת תפוקה:**
```
🎛️  מצב הלוגים הנוכחי:
========================================
📊 רמת לוג כללית:     INFO
🐛 דיבאג כללי:        ❌
💰 עלויות GPT:        ✅
📋 חילוץ נתונים:      ✅
⏱️  ביצועים:           ✅
💬 הודעות:            ✅
📊 גיליונות:          ❌
========================================
💡 לשינוי: ערוך את config.py או השתמש במשתני סביבה
```

### 🔧 עקיפה עם משתני סביבה

```bash
# Windows PowerShell
$env:ENABLE_GPT_COST_DEBUG="false"; python main.py

# Linux/Mac
ENABLE_GPT_COST_DEBUG=false python main.py

# הגדרה קבועה במשתני הסביבה של המערכת
export ENABLE_DATA_EXTRACTION_DEBUG=true
```

### 📁 קבצי לוג:
- **קונסול:** פלט מבוקר למסך
- **`data/bot.log`:** לוג מרכזי
- **`data/gpt_usage_log.jsonl`:** שימוש ב-GPT
- **`data/bot_trace_log.jsonl`:** מעקב אירועים

---

## 🫶 מערכת תזכורות עדינות

המערכת שולחת תזכורת עדינה למשתמשים שלא הגיבו במשך 3 שעות.

### ההודעה שנשלחת:
```
"היי, רק רציתי לבדוק מה שלומך. אין לחץ – פשוט כאן אם תצטרך."
```

### איך זה עובד:

1. **מעקב אחר פעילות**: כל הודעה מהמשתמש מאפסת את מצב התזכורת שלו
2. **בדיקה תקופתית**: המערכת בודקת כל שעה אילו משתמשים לא הגיבו במשך 3+ שעות
3. **שליחה חכמה**: תזכורת נשלחת רק פעם אחת עד שהמשתמש מגיב שוב
4. **התראה לאדמין**: האדמין מקבל הודעה כשנשלחת תזכורת

### בדיקה ואימות:

```bash
# ניקוי משתמשי בדיקה מפיתוח
python utils.py cleanup-test

# בדיקה עם הבוט האמיתי:
# 1. שלח הודעה לבוט
# 2. חכה 3+ שעות 
# 3. אמור לקבל תזכורת עדינה
# 4. אם תגיב - מצב התזכורת יתאפס
```

### מניעת בעיות עתידיות:

**ניקוי אוטומטי שבועי:**
- המערכת מנקה אוטומטיט משתמשים ישנים כל שבוע
- משתמשים שלא פעילים 90+ יום מסומנים כלא פעילים
- משתמשים שלא הגיבו לתזכורת 30+ יום מסומנים כלא פעילים

**זיהוי מוקדם של משתמשים לא פעילים:**
- בדיקת תקפות משתמש לפני שליחת תזכורת
- טיפול חכם בשגיאות "chat not found"
- סימון אוטומטי כלא פעיל למניעת ניסיונות חוזרים

### קבצי מעקב:
- `data/reminder_state.json` - מצב התזכורות שנשלחו
- `data/chat_history.json` - היסטוריית שיחות (לבדיקת זמני אינטראקציה)

### הגדרות:

**שינוי זמן התזכורת:**
ב-`notifications.py` שנה את:
```python
REMINDER_INTERVAL_HOURS = 3  # שנה ל-48 לייצור
```

**הודעת התזכורת:**
ב-`notifications.py` שנה את:
```python
GENTLE_REMINDER_MESSAGE = "ההודעה החדשה שלך כאן"
```

### לוגים ומעקב:

המערכת כותבת לוגים ב:
- רמת INFO: תזכורות שנשלחו
- רמת WARNING: משתמשים שסומנו כלא פעילים
- רמת ERROR: שגיאות במערכת
- התראות לאדמין: דרך `ADMIN_BOT_TELEGRAM_TOKEN`

### הערות טכניות:

- המערכת פועלת ב-background thread נפרד כדי לא לחסום את הבוט
- בדיקה מתבצעת כל שעה + ניקוי שבועי אוטומטי
- התזכורת נשלחת רק פעם אחת למשתמש
- כל הודעה חדשה מהמשתמש מאפסת את המצב
- המערכת ניגשת להיסטוריה ב-`data/chat_history.json`
- בדיקת תקפות משתמש לפני כל שליחת תזכורת

---

## 🐛 תיקוני באגים אחרונים

### תיקון כפילות שמירת הודעות בגיליון (2024)
**בעיה:** כל הודעה משתמש נשמרה פעמיים בגיליון Google Sheets, מה שגרם לשורות כפולות.

**סיבה:** הייתה קריאה כפולה לפונקציית `log_to_sheets`:
1. קריאה ראשונה ב-`handle_message` (שורות 734-745)
2. קריאה שנייה ב-`handle_background_tasks` (שורות 1163-1175)

**תיקון:** הוסרה הקריאה הכפולה הראשונה, והושארה רק הקריאה ב-`handle_background_tasks` שמבוצעת אחרי שכל הנתונים (GPT-A, GPT-B, GPT-C, GPT-D, GPT-E) מוכנים.

**קבצים שהשתנו:**
- `message_handler.py` - הוסרה קריאה כפולה ל-`log_to_sheets`

**תוצאה:** עכשיו כל הודעה נשמרת רק פעם אחת בגיליון, בשורה אחת כמו שצריך.
