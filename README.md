# Telegram GPT Bot — Daniel

בוט טלגרם חכם מבוסס GPT-4o, עם ניהול משתמשים, לוגים, Google Sheets, דוחות אוטומטיים, והרשאות מתקדמות.

**🔄 עדכון אחרון:** ארכיטקטורה מודולרית חדשה עם handlers נפרדים וקונפיגורציה מרכזית

---

## 🎯 מטרת הבוט

בוט טלגרם חכם שמספק **תמיכה רגשית ופסיכולוגית בעברית**. הבוט מנהל שיחות אמפתיות, עוזר למשתמשים לעבד רגשות, ומספק כלים להתמודדות עם אתגרים רגשיים.

**מה הבוט עושה:**
- מנהל שיחות תרפויטיות בעברית
- עוזר למשתמשים לעבד רגשות וטראומות
- מספק תמיכה בהתמודדות עם הומופוביה פנימית וחיצונית
- בונה פרופיל רגשי מתעדכן לכל משתמש
- שומר היסטוריית שיחות לצורך המשכיות טיפולית

**קהל היעד:** אנשים המחפשים תמיכה רגשית, במיוחד מהקהילה הלהט"בית, הזקוקים למרחב בטוח לשיחה על רגשות ואתגרים.

---

## 🚨 חשוב מאוד - שתי סביבות נפרדות!

### סביבה 1 - רנדר (ייצור):
- **הפעלה:** `python main.py`
- **לא משתמש ב-ngrok**
- **לא משתמש ב-sandbox.py**
- **רץ על פורט 8000 עם HTTP server פשוט**
- **מיועד לסביבת ייצור בלבד**

### סביבה 2 - לוקאלית (פיתוח):
- **הפעלה:** `python sandbox.py` ✅
- **משתמש ב-ngrok**
- **רץ על פורט 10000 עם uvicorn**
- **מיועד לפיתוח לוקאלי בלבד**

⚠️ **אזהרה חשובה:** אל תשנה את `main.py` כדי שיתאים לסביבה לוקאלית! הסביבה ברנדר לא אמורה לדעת בכלל על `sandbox.py`!

---

## 🚀 תכונות עיקריות
- מענה חכם בעברית (GPT-4o)
- ניהול משתמשים והרשאות בגיליונות Google Sheets
- לוגים מלאים לכל הודעה, כולל usage, עלויות, שגיאות
- דוחות usage ודוחות שגיאות אוטומטיים לאדמין
- מערכת הרשאות קשיחה (אדמין בלבד לפקודות רגישות)
- קוד מסודר, הודעות מרוכזות, שדות מרוכזים, דוקומנטציה מלאה
- **🆕 LiteLLM Integration** - ניהול עלויות מתקדם ותמיכה במודלים מרובים
- **🧠 מערכת 5 מנועי GPT מודולרית:**
  - **gpt_a** - תשובה ראשית למשתמש (Gemini 2.5 Pro + fallback ל-Flash)
  - **gpt_b** - תמצות תשובות להיסטוריה (Gemini 1.5 Pro - חינמי)
  - **gpt_c** - חילוץ פרופיל ראשוני (Gemini 1.5 Pro - חינמי)
  - **gpt_d** - מיזוג ואיכות פרופיל (Gemini 1.5 Pro - חינמי)
  - **gpt_e** - עדכון פרופיל מתקדם (Gemini 1.5 Pro - חינמי)
- **⚡ מערכת Concurrent Handling מתקדמת:**
  - **עד 10 משתמשים במקביל** עם זמני תגובה של 2-4 שניות
  - **FIFO Ordering** - כל משתמש מקבל שירות לפי סדר הגעה
  - **מנגנוני בטיחות** - Circuit Breaker, Timeout Protection, Auto Recovery
  - **Google Sheets Queue** - תור אסינכרוני עם Rate Limiting (60 ops/min)
  - **ניטור בזמן אמת** - מטריקות ביצועים והתראות אוטומטיות לאדמין
  - **Graceful Degradation** - התנהגות יציבה בעומסים גבוהים
  - **🚨 הגנה מפני קריסות** - מונע קריסת Google Sheets API ומערכת הבוט בעומסים גבוהים
- **🎤 תמיכה בהודעות קוליות:**
  - **תמלול אוטומטי לעברית** באמצעות Whisper-Ivrit
  - **הרצה מקומית חינמית** - אין עלויות API נוספות
  - **ביצועים מהירים** עם faster-whisper
  - **טיפול בשגיאות** וניקוי קבצים זמניים
  - **הודעות מותאמות** לכל סוגי ההודעות הלא-טקסטואליות

---

## 📦 התקנה והפעלה

### ⚠️ חשוב: הפעל את הבוט רק דרך sandbox.py!

📝 **הערה: מדריך זה מיועד לסביבת פיתוח לוקאלית (Cursor IDE) בלבד!**
בסביבת ייצור (production) יש להשתמש בהגדרות שרת מתאימות.

🚨 **הפעלה בסביבה לוקאלית:**
   ```bash
   python sandbox.py  ✅
   ```
   
   ❌ **אל תפעיל ישירות:**
   ```bash
   python main.py  ❌
   ```

1. **שכפול הריפו**
2. **הפעלת הבוט (הדרך הנכונה)**
   ```bash
   python sandbox.py
   ```
   
   הקובץ `sandbox.py`:
   - יוצר ומגדיר את סביבת הפיתוח (venv) אוטומטית
   - מתקין את כל התלויות הנדרשות
   - מפעיל את ngrok אוטומטית
   - מגדיר את webhook בטלגרם
   - מפעיל את הבוט עם uvicorn

3. **הגדרת קובץ קונפיגורציה**
   - ערוך את `etc/secrets/config.json` לפי הדוגמה למטה.

### ❌ אל תפעיל ישירות:
- `python main.py` - לא יעבוד כראוי
- `uvicorn main:app_fastapi` - חסר הגדרות סביבה

---

## ⚙️ דוגמת קובץ config.json
```json
{
  "TELEGRAM_BOT_TOKEN": "<הכנס כאן את הטוקן שלך>",
  "OPENAI_API_KEY": "<הכנס כאן את ה-API KEY שלך>",
  "GEMINI_API_KEY": "<הכנס כאן את ה-Gemini API KEY שלך>",
  "GOOGLE_SHEET_ID": "<מזהה הגיליון שלך>",
  "SERVICE_ACCOUNT_DICT": { ... },
  "ADMIN_BOT_TELEGRAM_TOKEN": "<טוקן בוט אדמין (רשות)>",
  "SHEET_USER_TAB": "user_profiles",
  "SHEET_LOG_TAB": "log",
  "SHEET_STATES_TAB": "user_states"
}
```

**🆕 קונפיגורציה מרכזית:**
- **שמות גיליונות:** רק ב-`config.json` - שינוי אחד משפיע על הכל
- **מודלים ופרמטרים:** רק ב-`config.py` - Single Source of Truth
- **שער דולר:** רק ב-`gpt_utils.py` - עדכון אוטומטי בכל מקום

---

## 🗂️ מבנה הקוד

### 📁 **קבצים עיקריים:**
- `main.py` — נקודת כניסה, FastAPI webhook
- `bot_setup.py` — אתחול הבוט, תזמון דוחות
- `message_handler.py` — טיפול בכל הודעה
- `sheets_handler.py` — עבודה מול Google Sheets
- `config.py` — הגדרות מרכזיות, מודלים ופרמטרים
- `utils.py` — לוגים, דוחות, בדיקות תקינות
- `messages.py` — כל ההודעות הקבועות
- `fields_dict.py` — כל שמות השדות במקום אחד
- `notifications.py` — התראות לאדמין, טיפול בשגיאות
- `secret_commands.py` — פקודות סודיות לאדמין
- `daily_summary.py` — דוחות יומיים
- `voice_handler.py` — תמלול הודעות קוליות לעברית

### 🧠 **מנועי GPT (Handlers):**
- `gpt_a_handler.py` — מנוע ראשי לתשובות איכותיות
- `gpt_b_handler.py` — מנוע תמצות להיסטוריה
- `gpt_c_handler.py` — מנוע חילוץ פרופיל ראשוני
- `gpt_d_handler.py` — מנוע מיזוג ואיכות פרופיל
- `gpt_e_handler.py` — מנוע עדכון פרופיל מתקדם
- `gpt_utils.py` — כלים משותפים (עלויות, נורמליזציה)

### 🛡️ **מערכת הגנה והפקוד:**
- `concurrent_monitor.py` — **🚨 קובץ קריטי!** מערכת הגנה מפני עומסים וקריסות
  - **למה קריטי:** מגביל ל-10 משתמשים במקביל, מגן על Google Sheets API מקריסה
  - **אל תמחק!** בלעדיו הבוט יקרוס בעומסים של 20+ משתמשים בו-זמנית
  - **משמש ב:** message_handler.py (15+ מקומות), secret_commands.py

### 📁 **תיקיות נוספות:**
- `recycle_bin/` — קבצים זמניים מהמיגרציה (לא עולה ל-GitHub)
- `tests/` — בדיקות אוטומטיות
- `data/` — נתונים ולוגים

---

## 🔄 ארכיטקטורה מודולרית חדשה

המערכת עברה רפקטורינג מלא לארכיטקטורה מודולרית:

### **עקרונות העיצוב:**
- **Single Source of Truth** - כל נתון מוגדר במקום אחד בלבד
- **DRY (Don't Repeat Yourself)** - אין שכפול של קוד או הגדרות
- **קונפיגורציה מרכזית** - כל שינוי במקום אחד משפיע על הכל
- **מודולריות** - כל מנוע GPT בקובץ נפרד עם אחריות ברורה

### **מה השתנה:**
- **לפני:** קובץ `gpt_handler.py` ענק אחד
- **אחרי:** 5 handlers נפרדים עם אחריות ברורה
- **לפני:** מודלים ופרמטרים פזורים בקוד
- **אחרי:** הכל ב-`config.py` במקום אחד
- **לפני:** שמות גיליונות קשיחים בקוד
- **אחרי:** הכל ב-`config.json` במקום אחד

### **יתרונות:**
- **תחזוקה קלה** - שינוי אחד במקום אחד
- **קריאות משופרת** - כל handler עם תפקיד ברור
- **בדיקות נקודתיות** - ניתן לבדוק כל מנוע בנפרד
- **גמישות** - קל להוסיף/לשנות מנועים
- **יציבות** - מערכת הגנה מפני עומסים וקריסות

---

## 🚨 הערה קריטית על concurrent_monitor.py

**⚠️ חשוב מאוד: concurrent_monitor.py הוא קובץ קריטי לפעולה תקינה של הבוט!**

### **למה הוא חיוני:**
- **🛡️ מגן על Google Sheets API** - מגביל ל-10 פעולות בו-זמנית
- **🚫 מונע קריסת הבוט** - מקסימום 10 משתמשים במקביל
- **⏰ מנגנון timeout** - מונע סשנים תקועים (30 שניות)
- **🧹 ניקוי אוטומטי** - מונע memory leaks

### **מה קורה בלעדיו:**
- **50+ משתמשים שולחים בו-זמנית** → Google Sheets API קורס מעודף בקשות
- **סשנים תקועים** → memory leaks וקריסת הבוט
- **אין מגבלות** → המערכת קורסת תחת עומס

### **תוצאה:**
- **עם concurrent_monitor:** מערכת יציבה עד 10 משתמשים במקביל ✅
- **בלי concurrent_monitor:** קריסה מוחלטת בעומסים גבוהים ❌

---

## 🧠 ניהול פרומטים (Prompts)
כל הפרומטים של הבוט מרוכזים בקובץ `prompts.py` בלבד:

### **פרומטים עיקריים:**
- **`SYSTEM_PROMPT`** (gpt_a) - פרומט ראשי לשיחה עם המשתמש
- **`BOT_REPLY_SUMMARY_PROMPT`** (gpt_b) - תמצות תשובת הבוט להיסטוריה
- **`PROFILE_EXTRACTION_ENHANCED_PROMPT`** (gpt_c/gpt_e) - חילוץ ועדכון פרופיל
- **`PROFILE_MERGE_PROMPT`** (gpt_d) - מיזוג ואיכות פרופיל

### **לוגיקת ההפעלה:**
- **gpt_a:** בכל הודעה מהמשתמש
- **gpt_b:** אחרי כל תשובה של הבוט
- **gpt_c:** על הודעות לא-טריוויאליות (negative logic)
- **gpt_d:** כשיש שינויים בפרופיל (smart merging)
- **gpt_e:** כל 50 אינטראקציות או 21+ אינטראקציות + 24 שעות

---

## 🛡️ מנגנון Fallback חכם

המערכת כוללת מנגנון fallback מתקדם שמבטיח יציבות ואמינות:

### **🎯 העקרון:**
- **GPT-A (ראשי)**: Gemini 2.5 Pro → fallback ל-Gemini 1.5 Flash
- **שאר המנועים**: Gemini 1.5 Pro (חינמי) - ללא צורך ב-fallback

### **🔄 איך זה עובד:**
1. **זיהוי אוטומטי של rate limits** - המערכת מזהה שגיאות quota/429
2. **מעבר חלק למודל גיבוי** - אוטומטית ללא הפרעה למשתמש  
3. **לוגים מפורטים** - רישום כל מעבר ל-fallback
4. **שקיפות מלאה** - מעקב איזה מודל שימש בפועל

### **📊 דוגמת פלט לוגים:**
```
[WARNING] [gpt_a] Rate limit for gemini-2.5-pro, trying fallback: gemini-1.5-flash
[INFO] [gpt_a] Fallback successful: gemini-1.5-flash
```

### **💡 יתרונות:**
- **אמינות גבוהה** - הבוט לא נתקע בגלל rate limits
- **חסכון חכם** - רק המנוע הראשי משתמש במודל בתשלום
- **חוויית משתמש רציפה** - אין הפרעה בזמן המעבר
- **שליטה מרכזית** - כל ההגדרות ב-`config.py`

---

## 📊 מעקב אינטראקציות ועלויות

### **סנכרון מושלם:**
- **ספירת אינטראקציות = ספירת קריאות gpt_a** (אחד לאחד)
- **לוג אוטומטי ל-`gpt_usage_log.jsonl`** לכל אינטראקציה
- **דוחות יומיים מדויקים** עם סיכום עלויות
- **מעקב אחר כל מנוע GPT** בנפרד

### **מבנה נתונים:**
```json
{
  "timestamp": "2025-01-27T...",
  "interaction_id": "msg_123",
  "chat_id": "456",
  "type": "gpt_a",
  "cost_total_ils": 0.15,
  "has_gpt_b": true,
  "has_gpt_c": false,
  "has_gpt_d": false,
  "has_gpt_e": false
}
```

---

## 🗺️ דיאגרמת זרימה (Mermaid)
```mermaid
graph TD
    A[משתמש שולח הודעה] --> B[message_handler.py]
    B --> C{משתמש חדש?}
    C -- כן --> D[onboarding + Sheets]
    C -- לא --> E[בדיקת הרשאות]
    E --> F{מאושר?}
    F -- לא --> G[אישור תנאים]
    F -- כן --> H[gpt_a_handler - תשובה ראשית]
    H --> I[gpt_b_handler - תמצות התשובה]
    I --> J{should_run_gpt_c?}
    J -- כן --> K[gpt_c_handler - חילוץ פרופיל]
    J -- לא --> L[שמירה ללוג + Sheets]
    K --> M{יש שינויים?}
    M -- כן --> N[gpt_d_handler - מיזוג פרופיל]
    M -- לא --> L
    N --> O{תנאי gpt_e?}
    O -- כן --> P[gpt_e_handler - עדכון מתקדם]
    O -- לא --> L
    P --> L
    L --> Q[log_gpt_usage_to_file]
    Q --> R[דוח יומי אוטומטי]
```

---

## 📝 דוגמת שימוש
- משתמש שולח הודעה ראשונה — עובר תהליך onboarding, נרשם בגיליון, מקבל הודעות קבלת פנים.
- משתמש שולח קוד לא תקין — מקבל הודעת שגיאה.
- כל שגיאה קריטית — נשלחת לאדמין בלבד.
- כל משתמש חדש — נשלחת התראה לאדמין בלבד.

---

## 📊 דוחות אוטומטיים
- דוח usage יומי/שבועי — נשלח אוטומטית לאדמין (מספר משתמשים, הודעות, שגיאות).
- דוח שגיאות יומי — נשלח אוטומטית לאדמין (ספירה לפי סוג שגיאה).
- **🆕 דוחות עלויות LiteLLM** - מעקב מדויק אחר עלויות לכל מודל
- ניתן להפעיל דוחות ידנית ע"י פקודות סודיות:
  - `#errors_report` — דוח שגיאות
  - `#usage_report` — דוח usage שבועי

---

## 🔒 הרשאות
- רק chat_id של האדמין יכול להפעיל פקודות סודיות (מחיקה, דוחות).
- כל פקודה סודית נבדקת מול ADMIN_NOTIFICATION_CHAT_ID.
- כל דוח usage/שגיאות נשלח רק לאדמין.

---

## 🧪 בדיקות אוטומטיות
- כל פונקציה קריטית ניתנת לבדיקה (unit test) בתיקיית `tests/`.
- **🆕 בדיקות LiteLLM** - וידוא תקינות המיגרציה
- להרצת כל הבדיקות:
  ```bash
  pytest
  ```

---

## 👨‍💻 תרומה/פיתוח
Pull Requests, Issues, ושאלות — תמיד יתקבלו בברכה!

**📋 לפני תרומה:**
- וודא שכל הבדיקות עוברות
- בדוק תאימות עם LiteLLM
- עדכן דוקומנטציה אם נדרש

---

## ⚡ מערכת Concurrent Handling

הבוט מסוגל לטפל ב-**10 משתמשים במקביל** עם מנגנוני בטיחות מתקדמים:

### 🎯 יעדי ביצועים:
- **זמן תגובה:** 2-4 שניות ממוצע
- **משתמשים במקביל:** עד 10 משתמשים
- **FIFO Ordering:** שירות לפי סדר הגעה
- **זמינות:** 99.9% uptime

### 🛡️ מנגנוני בטיחות:

#### **1. FIFO Queue System**
- כל משתמש מקבל מספר בתור לפי סדר הגעה
- אין "קפיצה בתור" - הגינות מלאה
- ניטור עמדות בתור בזמן אמת

#### **2. Circuit Breaker Pattern**
- הפעלה אוטומטית בעומסים גבוהים (>30% שגיאות)
- דחיית בקשות חדשות לשמירה על יציבות
- התאוששות אוטומטית כשהמערכת חוזרת לתקינות

#### **3. Timeout Protection**
- מקסימום 30 שניות לכל סשן משתמש
- ניקוי אוטומטי של סשנים תקועים
- מניעת memory leaks

#### **4. Google Sheets Rate Limiting**
- תור אסינכרוני עם 60 פעולות לדקה (60% מהמגבלה)
- Batch processing של 5 פעולות במקביל
- Retry mechanism לפעולות קריטיות
- Priority system: Critical > Normal > Low

#### **5. Auto Recovery Mechanisms**
- ניקוי סשנים תקועים כל 30 שניות
- איפוס מונים כל שעה
- התאוששות אוטומטית מכשלים

### 📊 ניטור וההתראות:

#### **מטריקות בזמן אמת:**
- משתמשים פעילים כעת
- זמני תגובה ממוצעים
- שיעור שגיאות
- אורך תור Google Sheets
- צריכת זיכרון

#### **התראות אוטומטיות לאדמין:**
- **🔴 עומס מקסימלי** - כשמגיעים ל-10 משתמשים
- **⚠️ זמן תגובה גבוה** - מעל 4 שניות ממוצע
- **🗂️ עומס Google Sheets** - תור מלא או איטי
- **❌ שגיאות מערכת** - כשל ברכיבים
- **🔥 כשל בתור** - פעולות שנדחו
- **✅ התאוששות** - חזרה לפעילות תקינה

### 🎛️ פקודות ניטור (אדמין בלבד):

```
/performance, /ביצועים, /stats - דוח מפורט
/status, /מצב - בדיקה מהירה
```

**דוגמת פלט דוח ביצועים:**
```
📊 דוח ביצועי Concurrent Handling
⏰ זמן יצירה: 25/06/2025 10:30:15

👥 משתמשים:
   • פעילים כעת: 7/10
   • ממוצע בשעה האחרונה: 5.2
   • מקסימום בשעה האחרונה: 9

⏱️ ביצועים:
   • זמן תגובה ממוצע: 2.8s ✅
   • זמן תגובה מקסימלי: 4.2s ✅
   • שיעור שגיאות: 0.5% ✅

🗂️ Google Sheets:
   • תור נוכחי: 3 פעולות
   • פעולות לדקה: 45/60 ✅
   
🔧 מצב מערכת: תקין ✅
```

### 📋 הגדרות קונפיגורציה:

```python
# config.py
MAX_CONCURRENT_USERS = 10  # מספר משתמשים מקסימלי
MAX_SHEETS_OPERATIONS_PER_MINUTE = 60  # 60% מהמגבלה
SHEETS_QUEUE_SIZE = 100  # גודל תור מקסימלי
SHEETS_BATCH_SIZE = 5  # פעולות במקביל
```

### 🔧 התקנה והפעלה:

המערכת מופעלת אוטומטית עם הבוט. לא נדרשת הגדרה נוספת.

**לבדיקת תקינות:**
```bash
python test_concurrent_system.py
```

---

בהצלחה! 