# CI/CD Pipeline for Python Telegram Bot
# ×§×•×‘×¥ ×–×” ××¨×™×¥ ×‘×“×™×§×•×ª ××•×˜×•××˜×™×•×ª ×•deployment ×œ-Render
# × ×•×¦×¨ ×‘×”×ª×× ×œ×‘×§×©×ª ×”××©×ª××©: CI ×‘×¡×™×¡×™ ×¢× deploy hook ×œ-Render

name: ğŸ¤– Python Bot CI/CD

# ××ª×™ ×œ×”×¨×™×¥ ××ª ×”-workflow
on:
  # ×›×œ push ×œ×¢× ×£ main
  push:
    branches: [ main ]
  
  # ×›×œ pull request ×œ×¢× ×£ main
  pull_request:
    branches: [ main ]

# ××©×ª× ×™ ×¡×‘×™×‘×” ×’×œ×•×‘×œ×™×™×
env:
  PYTHON_VERSION: "3.11"

jobs:
  # ×©×œ×‘ 1: ×‘×“×™×§×•×ª ×•×”×›× ×ª ×”×§×•×“
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout - ×”×•×¨×“×ª ×”×§×•×“ ××”-repository
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      # 2. ×”×’×“×¨×ª Python
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      # 3. Cache ×œ×ª×œ×•×™×•×ª Python (×××™×¥ ××ª ×”build ×”×‘×)
      - name: ğŸ’¾ Cache Python Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      # 4. ×”×ª×§× ×ª ×ª×œ×•×™×•×ª ××”×§×•×‘×¥ requirements.txt
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # 5. ×‘×“×™×§×ª ×ª×—×‘×™×¨ Python (Linting)
      - name: ğŸ” Check Python Syntax
        run: |
          python -m py_compile *.py
          echo "âœ… ×›×œ ×§×‘×¦×™ Python ×¢×‘×¨×• ×‘×“×™×§×ª ×ª×—×‘×™×¨ ×‘×”×¦×œ×—×”!"
          
      # 6. ×”×¨×¦×ª ×‘×“×™×§×•×ª ×¢× pytest
      - name: ğŸ§ª Run Tests with pytest
        run: |
          # ×× ××™×Ÿ ×ª×™×§×™×™×ª tests, pytest ×™×¨×™×¥ discovery mode
          # ×•×™×—×¤×© ×§×‘×¦×™× ×©××ª×—×™×œ×™× ×‘-test_ ××• ××¡×ª×™×™××™× ×‘-_test.py
          python -m pytest -v --tb=short || echo "âš ï¸ ×œ× × ××¦××• ×‘×“×™×§×•×ª, ××‘×œ ×–×” ×‘×¡×“×¨ ×œ×¢×ª ×¢×ª×”"
          echo "âœ… ×©×œ×‘ ×”×‘×“×™×§×•×ª ×”×•×©×œ×!"

  # ×©×œ×‘ 2: Deploy ×œ-Render (×¨×§ ××—×¨×™ ×©×”×‘×“×™×§×•×ª ×¢×‘×¨×• ×‘×”×¦×œ×—×”)
  deploy:
    name: ğŸš€ Deploy to Render
    runs-on: ubuntu-latest
    needs: test  # ×™×¨×™×¥ ×¨×§ ×× job test ×¢×‘×¨ ×‘×”×¦×œ×—×”
    
    # ×™×¨×™×¥ ×¨×§ ×¢×œ push ×œmain (×œ× ×¢×œ pull requests)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      # 1. Deploy ×œ-Render ×“×¨×š Deploy Hook
      - name: ğŸš€ Trigger Render Deploy
        run: |
          echo "ğŸ”„ ××ª×—×™×œ deployment ×œ-Render..."
          
          # ×‘×“×™×§×” ×©×”-Deploy Hook ×§×™×™×
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            echo "âŒ ×©×’×™××”: RENDER_DEPLOY_HOOK_URL ×œ× ××•×’×“×¨ ×‘-GitHub Secrets!"
            echo "ğŸ“ ×”×•×¨××•×ª:"
            echo "1. ×œ×š ×œ-GitHub repository settings"
            echo "2. ×‘×—×¨ Secrets and variables > Actions"
            echo "3. ×”×•×¡×£ secret ×—×“×© ×‘×©×: RENDER_DEPLOY_HOOK_URL"
            echo "4. ×”×›× ×¡ ××ª ×”-URL ×©×œ Deploy Hook ×Render"
            exit 1
          fi
          
          # ×©×œ×™×—×ª POST request ×œ-Render Deploy Hook
          echo "ğŸ”„ ×©×•×œ×— Deploy Hook ×œ-Render..."
          
          # ×‘×™×¦×•×¢ ×”×§×¨×™××” ×¢× ×˜×™×¤×•×œ ×‘×©×’×™××•×ª
          if curl -s -f -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions" \
            --max-time 30 \
            --retry 3 \
            --retry-delay 2 \
            -d '{"ref": "main"}' \
            "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"; then
            echo "âœ… Deploy Hook × ×©×œ×— ×‘×”×¦×œ×—×” ×œ-Render!"
            echo "ğŸ‰ ×”deployment ×”×—×œ - ×ª×•×›×œ ×œ×¢×§×•×‘ ××—×¨ ×”×”×ª×§×“××•×ª ×‘-Render Dashboard"
          else
            echo "âŒ ×©×’×™××” ×‘×©×œ×™×—×ª Deploy Hook"
            echo "ğŸ” ×‘×“×™×§×•×ª ××¤×©×¨×™×•×ª:"
            echo "  - ×•×“× ×©×”-RENDER_DEPLOY_HOOK_URL × ×›×•×Ÿ ×‘-GitHub Secrets"
            echo "  - ×‘×“×•×§ ×©×”-Deploy Hook ×¢×“×™×™×Ÿ ×¤×¢×™×œ ×‘-Render Dashboard"
            echo "  - ×•×“× ×©××™×Ÿ ×‘×¢×™×•×ª ×¨×©×ª ×–×× ×™×•×ª"
            exit 1
          fi
          
      # 2. ×”×•×“×¢×ª ×¡×™×›×•×
      - name: âœ… Deployment Summary
        run: |
          echo "ğŸ¯ ×¡×™×›×•× Deployment:"
          echo "ğŸ“… ×–××Ÿ: $(date)"
          echo "ğŸŒ¿ ×¢× ×£: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ ××‘×¦×¢: ${{ github.actor }}"
          echo "ğŸš€ ×¡×˜×˜×•×¡: ×”×•×©×œ× ×‘×”×¦×œ×—×”!"