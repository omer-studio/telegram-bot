# CI/CD Pipeline for Python Telegram Bot
# ×§×•×‘×¥ ×–×” ××¨×™×¥ deployment ×œ-Render
# ×”×•×¡×¨×• ×”×‘×“×™×§×•×ª ×”××•×˜×•××˜×™×•×ª ×œ×× ×™×¢×ª ×©×’×™××•×ª ×‘××™×™×œ

name: ğŸ¤– Python Bot CI/CD

# ××ª×™ ×œ×”×¨×™×¥ ××ª ×”-workflow
on:
  # ×›×œ push ×œ×¢× ×£ main
  push:
    branches: [ main ]
  
  # ×›×œ pull request ×œ×¢× ×£ main
  pull_request:
    branches: [ main ]

# ××©×ª× ×™ ×¡×‘×™×‘×” ×’×œ×•×‘×œ×™×™×
env:
  PYTHON_VERSION: "3.11"

jobs:
  # Deploy ×œ-Render (×œ×œ× ×‘×“×™×§×•×ª ××•×§×“××•×ª)
  deploy:
    name: ğŸš€ Deploy to Render
    runs-on: ubuntu-latest
    
    # ×™×¨×™×¥ ×¨×§ ×¢×œ push ×œmain (×œ× ×¢×œ pull requests)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      # 1. Deploy ×œ-Render ×“×¨×š Deploy Hook
      - name: ğŸš€ Trigger Render Deploy
        env:
          # âœ… GitHub Actions secret - IDE warning is false positive, works perfectly in GitHub Actions
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          echo "ğŸ”„ ××ª×—×™×œ deployment ×œ-Render..."
          
          # ×©×œ×™×—×ª POST request ×œ-Render Deploy Hook
          echo "ğŸ”„ ×©×•×œ×— Deploy Hook ×œ-Render..."
          
          # ×©×œ×™×—×ª ×”×§×¨×™××”
          if curl -v --max-time 30 --retry 3 --retry-delay 2 --fail-with-body "$RENDER_DEPLOY_HOOK_URL"; then
            echo ""
            echo "âœ… Deploy Hook × ×©×œ×— ×‘×”×¦×œ×—×” ×œ-Render!"
            echo "ğŸ‰ ×”deployment ×”×—×œ - ×ª×•×›×œ ×œ×¢×§×•×‘ ××—×¨ ×”×”×ª×§×“××•×ª ×‘-Render Dashboard"
          else
            CURL_EXIT_CODE=$?
            echo ""
            echo "âŒ ×©×’×™××” ×‘×©×œ×™×—×ª Deploy Hook (Exit Code: $CURL_EXIT_CODE)"
            exit 1
          fi
          
      # 2. ×”×•×“×¢×ª ×¡×™×›×•×
      - name: âœ… Deployment Summary
        run: |
          echo "ğŸ¯ ×¡×™×›×•× Deployment:"
          echo "ğŸ“… ×–××Ÿ: $(date)"
          echo "ğŸŒ¿ ×¢× ×£: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ ××‘×¦×¢: ${{ github.actor }}"
          echo "ğŸš€ ×¡×˜×˜×•×¡: ×”×•×©×œ× ×‘×”×¦×œ×—×”!"