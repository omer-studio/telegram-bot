name: ğŸš¨ Deploy Safety Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  health-check:
    name: ğŸ” Pre-Deploy Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        
    - name: ğŸš¨ Run Critical Health Check
      run: |
        echo "ğŸš¨ ×¨×¥ ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×§×¨×™×˜×™×ª..."
        python3 health_check.py
      env:
        # Add any required environment variables for testing
        TELEGRAM_BOT_TOKEN: "dummy_token_for_testing"
        MAX_CONCURRENT_USERS: 5
        
    - name: âœ… Health Check Passed
      if: success()
      run: |
        echo "ğŸ‰ ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×¢×‘×¨×” ×‘×”×¦×œ×—×”!"
        echo "âœ… ×”×¤×¨×™×¡×” ×™×›×•×œ×” ×œ×”××©×™×š!"
        
    - name: âŒ Health Check Failed
      if: failure()
      run: |
        echo "ğŸš¨ ×‘×“×™×§×ª ×ª×§×™× ×•×ª × ×›×©×œ×”!"
        echo "âŒ ×”×¤×¨×™×¡×” × ×—×¡××”!"
        echo "ğŸ”§ ×ª×ª×§×Ÿ ××ª ×”×©×’×™××•×ª ×œ×¤× ×™ ×©×ª× ×¡×” ×©×•×‘"
        exit 1

  # Job × ×•×¡×£ ×©×¨×¥ ×¨×§ ×× health-check ×¢×‘×¨
  deployment-gate:
    name: ğŸšª Deployment Gate
    runs-on: ubuntu-latest
    needs: health-check
    if: success()
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3
      
    - name: ğŸ Setup Python  
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
    
    - name: ğŸš¨ Post-Deploy Safety Check (Simulation)
      run: |
        echo "ğŸš¨ ××¨×™×¥ ×‘×“×™×§×ª post-deploy (×¡×™××•×œ×¦×™×”)..."
        python3 auto_rollback.py
      env:
        TELEGRAM_BOT_TOKEN: "dummy_token_for_testing"
        ADMIN_BOT_TELEGRAM_TOKEN: "dummy_token_for_testing" 
        ADMIN_NOTIFICATION_CHAT_ID: "dummy_chat_id"
        
    - name: ğŸ‰ Ready for Deployment
      run: |
        echo "âœ… ×›×œ ×”×‘×“×™×§×•×ª ×¢×‘×¨×• ×‘×”×¦×œ×—×”!"
        echo "âœ… ×× ×’× ×•×Ÿ rollback ××•×›×Ÿ ×•×¢×•×‘×“!"
        echo "ğŸš€ ×”×‘×•×˜ ××•×›×Ÿ ×œ×¤×¨×™×¡×” ×‘×˜×•×—×”!"
        
    # ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ steps ×©×œ deploy ×××™×ª×™
    # ×œ××©×œ deploy ×œRender, Railway, Heroku ×•×›×•'