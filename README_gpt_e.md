# 📄 מודול gpt_e - חידוד ותיקון פרופיל רגשי

## 🎯 מהות המודול

`gpt_e` הוא מנגנון חכם שמשלים ומתקן את **הפרופיל הרגשי** של כל משתמש,
על בסיס **השיחה האחרונה** מול הבוט + **הפרופיל הקיים** שכבר נשמר.

### מטרות:
- גילוי מידע רגשי שנאמר במרומז או לאורך זמן
- תיקון טעויות או שיבושים שהוזנו בעבר
- חידוד והתפתחויות בזהות הרגשית של המשתמש
- ניקוי וחידוד הפרופיל הרגשי

## 🧠 למה זה נדרש?

`gpt_c` (nano) מנתח כל הודעה בנפרד, אך הוא:
- מוגבל להבנה של הקשר רחב
- מפספס מידע שנאמר בעקיפין
- עלול לשייך מילים לשדה שגוי

`gpt_e` מבצע **סקירה רחבה**, על סמך הקשר, ומתקן לפי הצורך.

## 🔄 מתי המודול מופעל?

המנוע מופעל על משתמש רק אם מתקיים לפחות אחד מהתנאים:

```python
if gpt_c_run_count >= 50:
    run_gpt_e()
elif gpt_c_run_count >= 21 and time_since_last_gpt_e >= 24 שעות:
    run_gpt_e()
```

**הערה חשובה:** ההפעלה מתבצעת רק כאשר יש אינטראקציה חדשה (ריצת gpt_c), ולא על בסיס טיימר.

## 📁 קבצים שנוספו/שונו

### קבצים חדשים:
- `gpt_e_handler.py` - המודול הראשי של gpt_e
- `test_gpt_e.py` - קובץ בדיקה
- `README_gpt_e.md` - תיעוד זה

### קבצים שעודכנו:
- `message_handler.py` - הוספת אינטגרציה עם gpt_e
- `sheets_handler.py` - הוספת פונקציות ניהול מצב משתמש
- `secret_commands.py` - הוספת פקודת אדמין להפעלה ידנית

## 🛠 פונקציות עיקריות

### gpt_e_handler.py

#### `execute_gpt_e_if_needed(chat_id, gpt_c_run_count, last_gpt_e_timestamp)`
- בודקת תנאי הפעלה ומפעילה gpt_e אם צריך
- מחזירה תוצאות הריצה או None

#### `run_gpt_e(chat_id)`
- הפונקציה הראשית שמבצעת את כל התהליך
- שולפת היסטוריה, פרופיל קיים, שולחת ל-GPT-4, מעדכנת פרופיל

#### `prepare_gpt_e_prompt(chat_history, current_profile)`
- מכינה פרומפט מותאם ל-gpt_e עם ההיסטוריה והפרופיל

### sheets_handler.py

#### `get_user_state(chat_id)`
- מחזירה את מצב המשתמש מגיליון user_states

#### `increment_gpt_c_run_count(chat_id)`
- מגדילה את מונה ריצות gpt_c ב-1

#### `reset_gpt_c_run_count(chat_id)`
- מאפסת את מונה gpt_c_run_count ומעדכנת last_gpt_e_timestamp

## 📊 לוגים וניטור

### לוגים נשמרים ב:
- `GPT_LOG_PATH` - לוגים מפורטים של כל ריצת gpt_e
- Google Sheets - נתוני שימוש ועלויות
- Console - הודעות דיבאג מפורטות

### נתונים שנשמרים:
- מספר טוקנים (prompt, completion, cached)
- עלויות (USD, ILS, אגורות)
- זמן ביצוע
- שינויים שנעשו בפרופיל
- שגיאות (אם יש)

## 🔧 פקודות אדמין

### הפעלה ידנית:
```
#run_gpt_e <chat_id>
```

**דוגמה:**
```
#run_gpt_e 123456789
```

**תוצאה:**
```
✅ gpt_e הופעל בהצלחה על chat_id=123456789
📊 שינויים: 3
🔢 טוקנים: 1250
⏱️ זמן: 2.34 שניות
```

## 🧪 בדיקות

### הרצת בדיקות:
```bash
python test_gpt_e.py
```

### בדיקות כלולות:
- ייבוא מודולים
- פונקציות ניהול מצב משתמש
- תנאי הפעלת gpt_e
- פקודות אדמין

## 📈 אינטגרציה עם המערכת

### זרימת עבודה:
1. משתמש שולח הודעה
2. gpt_c רץ ומעדכן פרופיל
3. מונה gpt_c_run_count מוגדל
4. בדיקה אם צריך להפעיל gpt_e
5. אם כן - gpt_e רץ ומחדד את הפרופיל
6. מונה מתאפס וטיימסטמפ מתעדכן

### עדכון לוגים:
- כל הנתונים של gpt_e נכללים בלוגים הכלליים
- עלויות gpt_e נכללות בחישובי העלות הכוללים
- טוקנים של gpt_e נכללים בספירה הכוללת

## 🔒 אבטחה

- רק אדמין יכול להפעיל gpt_e ידנית
- כל הפעלה מתועדת עם פרטים מלאים
- שגיאות מטופלות ומתועדות
- אין גישה לנתונים רגישים

## 🚀 שימוש

### הפעלה אוטומטית:
המודול פועל אוטומטית לפי התנאים שהוגדרו.

### הפעלה ידנית (אדמין בלבד):
```
#run_gpt_e <chat_id>
```

### ניטור:
- בדיקת לוגים ב-`GPT_LOG_PATH`
- בדיקת נתונים בגיליון Google Sheets
- מעקב אחר עלויות וטוקנים

## 📝 הערות חשובות

1. **ביצועים:** gpt_e רץ רק כאשר יש צורך, לא בכל אינטראקציה
2. **עלויות:** gpt_e משתמש ב-GPT-4o (יקר יותר מ-nano)
3. **זמן:** ריצה אורכת 2-5 שניות בממוצע
4. **תוצאות:** רק שדות חדשים/מתוקנים נשמרים
5. **שגיאות:** מטופלות ומתועדות ללא קריסת המערכת

## 🔄 תחזוקה

### ניקוי לוגים:
- לוגים נשמרים אוטומטית
- אין צורך בניקוי ידני

### עדכון פרומפט:
- הפרומפט נמצא ב-`prompts.py`
- שינויים נטענים אוטומטית

### מעקב ביצועים:
- זמן ביצוע ממוצע: 2-5 שניות
- טוקנים ממוצעים: 1000-2000
- עלות ממוצעת: $0.01-0.03 לריצה

---

**פותח על ידי:** AI Assistant  
**תאריך:** 2025  
**גרסה:** 1.0 